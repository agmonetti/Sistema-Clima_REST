-- SECCIÓN 1: DEFINICIÓN DE TIPOS ENUM

CREATE TYPE "roles" AS ENUM (
    'usuario',
    'tecnico',
    'administrativo'
);

CREATE TYPE "estadoFactura" AS ENUM (
    'pendiente',
    'pagada',
    'vencida'
);


-- SECCIÓN 2: CREACIÓN DE TABLAS (Sin Foreign Keys)
-- El orden de esta sección ya no importa, pero las mantenemos lógicas.

CREATE TABLE IF NOT EXISTS "Rol" (
    "rol_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "descripcion" roles NOT NULL,
    PRIMARY KEY("rol_id")
);

CREATE TABLE IF NOT EXISTS "Metodos_Pago" (
    "metodo_pago_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "nombre" VARCHAR(255) NOT NULL,
    "isActive" BOOLEAN DEFAULT TRUE,
    PRIMARY KEY("metodo_pago_id")
);

CREATE TABLE IF NOT EXISTS "Usuario" (
    "usuario_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "nombre" VARCHAR(255) NOT NULL,
    "mail" VARCHAR(255) UNIQUE NOT NULL,
    "fechaRegistro" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "rol_id" BIGINT NOT NULL,
    "isActive" BOOLEAN DEFAULT TRUE,
    PRIMARY KEY("usuario_id")
    -- La FK a Rol se agrega abajo
);

CREATE TABLE IF NOT EXISTS "Usuario_Credencial" (
    "usuario_id" BIGINT NOT NULL UNIQUE,
    "contraseña" VARCHAR(255) NOT NULL,
    PRIMARY KEY("usuario_id")
    -- La FK a Usuario se agrega abajo
);

CREATE TABLE IF NOT EXISTS "Cuentas_Corrientes" (
    "cuenta_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "usuario_id" BIGINT NOT NULL UNIQUE,
    "saldoActual" DECIMAL(12,2) DEFAULT 0.00,
    PRIMARY KEY("cuenta_id")
    -- La FK a Usuario se agrega abajo
);

CREATE TABLE IF NOT EXISTS "Solicitud_Proceso" (
    "solicitud_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "usuario_id" BIGINT NOT NULL,
    "proceso_id" VARCHAR(24),
    "fechaSolicitud" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "isCompleted" BOOLEAN DEFAULT FALSE,
    PRIMARY KEY("solicitud_id")
    -- La FK a Usuario se agrega abajo
);

CREATE TABLE IF NOT EXISTS "Facturas" (
    "factura_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "usuario_id" BIGINT NOT NULL,
    "solicitud_id" BIGINT,
    "fechaEmision" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "estadoFactura" estadoFactura DEFAULT 'pendiente',
    PRIMARY KEY("factura_id")
    -- Las FKs a Usuario y Solicitud_Proceso se agregan abajo
);

CREATE TABLE IF NOT EXISTS "Pagos" (
    "pago_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "factura_id" BIGINT NOT NULL,
    "fechaPago" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "montoPagado" DECIMAL(10,2) NOT NULL CHECK ("montoPagado" > 0),
    "metodo_pago_id" BIGINT NOT NULL,
    PRIMARY KEY("pago_id")
    -- Las FKs a Facturas y Metodos_Pago se agregan abajo
);

CREATE TABLE IF NOT EXISTS "Historial_Ejecucion_Procesos" (
    "ejecucion_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "solicitud_id" BIGINT NOT NULL,
    "factura_id" BIGINT,
    "fechaEjecucion" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "resultado" TEXT,
    "isCompleted" BOOLEAN DEFAULT FALSE,
    PRIMARY KEY("ejecucion_id")
    -- Las FKs a Solicitud_Proceso y Facturas se agregan abajo
);

CREATE TABLE IF NOT EXISTS "Movimientos_CC" (
    "movimiento_id" BIGINT NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "cuenta_id" BIGINT NOT NULL,
    "monto" DECIMAL(10,2) NOT NULL,
    "fechaMovimiento" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    "referencia_factura_id" BIGINT,
    "referencia_pago_id" BIGINT,
    PRIMARY KEY("movimiento_id")
    -- Las FKs a Cuentas_Corrientes, Facturas y Pagos se agregan abajo
);


-- SECCIÓN 3: ADICIÓN DE CLAVES FORÁNEAS (ALTER TABLE)
-- Esto se ejecuta después de que todas las tablas existen.

-- Usuario y Credenciales
ALTER TABLE "Usuario" ADD CONSTRAINT fk_usuario_rol FOREIGN KEY("rol_id") REFERENCES "Rol"("rol_id") ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Usuario_Credencial" ADD CONSTRAINT fk_credencial_usuario FOREIGN KEY("usuario_id") REFERENCES "Usuario"("usuario_id") ON UPDATE CASCADE ON DELETE CASCADE;

-- Cuentas Corrientes y Solicitud Proceso
ALTER TABLE "Cuentas_Corrientes" ADD CONSTRAINT fk_cc_usuario FOREIGN KEY("usuario_id") REFERENCES "Usuario"("usuario_id") ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Solicitud_Proceso" ADD CONSTRAINT fk_sp_usuario FOREIGN KEY("usuario_id") REFERENCES "Usuario"("usuario_id") ON UPDATE CASCADE ON DELETE RESTRICT;

-- Facturas
ALTER TABLE "Facturas" ADD CONSTRAINT fk_factura_usuario FOREIGN KEY("usuario_id") REFERENCES "Usuario"("usuario_id") ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Facturas" ADD CONSTRAINT fk_factura_solicitud FOREIGN KEY("solicitud_id") REFERENCES "Solicitud_Proceso"("solicitud_id") ON UPDATE CASCADE ON DELETE SET NULL;

-- Pagos
ALTER TABLE "Pagos" ADD CONSTRAINT fk_pago_factura FOREIGN KEY("factura_id") REFERENCES "Facturas"("factura_id") ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Pagos" ADD CONSTRAINT fk_pago_metodo FOREIGN KEY("metodo_pago_id") REFERENCES "Metodos_Pago"("metodo_pago_id") ON UPDATE CASCADE ON DELETE RESTRICT;

-- Historial Ejecucion Procesos
ALTER TABLE "Historial_Ejecucion_Procesos" ADD CONSTRAINT fk_historial_solicitud FOREIGN KEY("solicitud_id") REFERENCES "Solicitud_Proceso"("solicitud_id") ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Historial_Ejecucion_Procesos" ADD CONSTRAINT fk_historial_factura FOREIGN KEY("factura_id") REFERENCES "Facturas"("factura_id") ON UPDATE CASCADE ON DELETE SET NULL;

-- Movimientos CC
ALTER TABLE "Movimientos_CC" ADD CONSTRAINT fk_mov_cuenta FOREIGN KEY("cuenta_id") REFERENCES "Cuentas_Corrientes"("cuenta_id") ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Movimientos_CC" ADD CONSTRAINT fk_mov_factura FOREIGN KEY("referencia_factura_id") REFERENCES "Facturas"("factura_id") ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE "Movimientos_CC" ADD CONSTRAINT fk_mov_pago FOREIGN KEY("referencia_pago_id") REFERENCES "Pagos"("pago_id") ON UPDATE CASCADE ON DELETE SET NULL;


-- ÍNDICES (Siempre al final, aunque podrían ir en la sección 2)
CREATE INDEX idx_usuario_mail ON "Usuario"("mail");
CREATE INDEX idx_usuario_rol ON "Usuario"("rol_id");
CREATE INDEX idx_facturas_usuario ON "Facturas"("usuario_id");
CREATE INDEX idx_facturas_estado ON "Facturas"("estadoFactura");
CREATE INDEX idx_pagos_factura ON "Pagos"("factura_id");
CREATE INDEX idx_movimientos_cuenta ON "Movimientos_CC"("fechaMovimiento");
